<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Schichtkasse</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.27/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f8f9fa;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 600px;
      text-align: center;
      max-height: 90vh;
      overflow-y: auto;
    }
    input {
      width: 80%;
      padding: 10px;
      margin: 6px 0 12px 0;
      border-radius: 6px;
      font-size: 16px;
      border: 1px solid #ddd;
    }
    /* Labels nur im Bearbeiten-Modus anzeigen */
    .edit-label {
      display: block;
      font-weight: bold;
      margin-top: 10px;
      text-align: left;
    }
    button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 6px;
      font-size: 16px;
      border: none;
      cursor: pointer;
      transition: 0.3s;
    }
    .btn-add { background: #28a745; color: white; }
    .btn-export { background: #007bff; color: white; }
    .btn-share { background: #25D366; color: white; }
    .btn-reset { background: #dc3545; color: white; }
    .btn-edit { background: #ffc107; color: black; }
    .btn-save { background: #17a2b8; color: white; }
    .btn-print { background: #6c757d; color: white; }

    .entry {
      border: 2px solid #007bff;
      padding: 12px;
      border-radius: 6px;
      margin: 8px 0;
      background: #e9ecef;
      text-align: left;
    }
    .summary-box {
      background: #d4edda;
      padding: 12px;
      border-radius: 6px;
      margin: 12px 0;
      text-align: center;
      border: 2px solid #28a745;
      font-weight: bold;
    }
    .rahmen {
      border: 2px solid #ff00ee;
      padding: 10px;
      width: fit-content;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ğŸ“Š Taxi-Kasse</h2>

    <input type="text" id="fahrername" placeholder="Fahrername" required oninput="saveFahrername()">
    <input type="number" id="summe" placeholder="Summe (â‚¬)" oninput="calculateRueckgeld()">
    <input type="number" id="gegeben" placeholder="Gegeben (â‚¬)" oninput="calculateRueckgeld()">
    <input type="number" id="rueckgeld" placeholder="RÃ¼ckgeld (berechnet)" readonly>
    <input type="number" id="rueckgeldTats" placeholder="RÃ¼ckgeld (tatsÃ¤chlich)" oninput="calculateTrinkgeld()">
    <input type="number" id="trinkgeld" placeholder="Trinkgeld (â‚¬)" readonly>
    <input type="number" id="ecZahlung" placeholder="EC-Zahlung (â‚¬)">
    <input type="number" id="ecTrinkgeld" placeholder="Trinkgeld bei EC (â‚¬)">

    <button class="btn-add" onclick="addEntry()">â• Berechnen</button>

    <div id="output"></div>

    <hr>
    <button class="btn-export" onclick="exportPDF()">ğŸ“„ PDF speichern</button>
    <button class="btn-print" onclick="printHTML()">ğŸ–¨ï¸ Drucken</button>
    <button class="btn-share" onclick="shareWhatsApp()">ğŸ“± Teilen via WhatsApp</button>
    <button class="btn-reset" onclick="resetData()">ğŸ—‘ï¸ Alle Daten lÃ¶schen</button>
  </div>

  <script>
    let einnahmen = JSON.parse(localStorage.getItem("einnahmen")) || [];

    function saveFahrername() {
      const name = document.getElementById("fahrername").value.trim();
      if (name) localStorage.setItem("fahrername", name);
    }

    function calculateRueckgeld() {
      const summe = parseFloat(document.getElementById("summe").value) || 0;
      const gegeben = parseFloat(document.getElementById("gegeben").value) || 0;
      const rueckgeld = Math.max(gegeben - summe, 0);
      document.getElementById("rueckgeld").value = rueckgeld.toFixed(2);
      calculateTrinkgeld();
    }

    function calculateTrinkgeld() {
      const rueckgeld = parseFloat(document.getElementById("rueckgeld").value) || 0;
      const rueckgeldTats = parseFloat(document.getElementById("rueckgeldTats").value) || 0;
      const trinkgeld = Math.max(rueckgeld - rueckgeldTats, 0);
      document.getElementById("trinkgeld").value = trinkgeld.toFixed(2);
    }

    function addEntry() {
      const summe = parseFloat(document.getElementById("summe").value) || 0;
      const gegeben = parseFloat(document.getElementById("gegeben").value) || 0;
      const rueckgeld = parseFloat(document.getElementById("rueckgeld").value) || 0;
      const rueckgeldTats = parseFloat(document.getElementById("rueckgeldTats").value) || 0;
      const trinkgeld = parseFloat(document.getElementById("trinkgeld").value) || 0;
      const ecZahlung = parseFloat(document.getElementById("ecZahlung").value) || 0;
      const ecTrinkgeld = parseFloat(document.getElementById("ecTrinkgeld").value) || 0;
      const einnahme = summe + ecZahlung;
      const timestamp = new Date().toLocaleString("de-DE");

      einnahmen.unshift({ summe, gegeben, rueckgeld, rueckgeldTats, trinkgeld, ecZahlung, ecTrinkgeld, einnahme, timestamp });
      localStorage.setItem("einnahmen", JSON.stringify(einnahmen));

      document.getElementById("summe").value = "";
      document.getElementById("gegeben").value = "";
      document.getElementById("rueckgeld").value = "";
      document.getElementById("rueckgeldTats").value = "";
      document.getElementById("trinkgeld").value = "";
      document.getElementById("ecZahlung").value = "";
      document.getElementById("ecTrinkgeld").value = "";

      displayEntries();
    }

    function displayEntries() {
      const output = document.getElementById("output");
      output.innerHTML = "";

      let totalBar = 0, totalEC = 0, totalTrinkgeld = 0, totalECTrinkgeld = 0;

      einnahmen.forEach((entry, index) => {
        totalBar += entry.summe;
        totalEC += entry.ecZahlung;
        totalTrinkgeld += entry.trinkgeld;
        totalECTrinkgeld += entry.ecTrinkgeld;

        output.innerHTML += 
          `<div class="entry" id="entry-${index}">
            ğŸ“… ${entry.timestamp}<br><hr>
            ğŸ’µ Bar-Zahlung: ${entry.summe.toFixed(2)}â‚¬<br>
            ğŸ’³ EC-Zahlung: ${entry.ecZahlung.toFixed(2)}â‚¬<br><hr>
            ğŸ Trinkgeld (Bar): ${entry.trinkgeld.toFixed(2)}â‚¬<br>
            ğŸ Trinkgeld (EC): ${entry.ecTrinkgeld.toFixed(2)}â‚¬<br>
            <button class="btn-edit" onclick="editEntry(${index})">âœï¸ Bearbeiten</button>
          </div>`;
      });

      output.innerHTML += 
        `<div class="summary-box">
          ğŸ’µ Gesamt Bar: ${totalBar.toFixed(2)}â‚¬<br>
          ğŸ’³ Gesamt EC : ${totalEC.toFixed(2)}â‚¬<br><hr>
          <center><div class="rahmen">ğŸ“† Gesamteinnahmen: ${(totalBar + totalEC).toFixed(2)}â‚¬<br><hr>
          ğŸ Gesamt Trinkgeld : ${(totalTrinkgeld + totalECTrinkgeld).toFixed(2)}â‚¬</div></center>
        </div>`;
    }

    function editEntry(index) {
      const entry = einnahmen[index];
      const container = document.getElementById(`entry-${index}`);
      container.innerHTML = 
        `<div>
          ğŸ“… ${entry.timestamp}<br><hr>
          <label class="edit-label" for="edit-summe">Summe (â‚¬):</label>
          <input type="number" id="edit-summe" value="${entry.summe}" oninput="updateRueckgeld(${index})"><br>
          <label class="edit-label" for="edit-gegeben">Gegeben (â‚¬):</label>
          <input type="number" id="edit-gegeben" value="${entry.gegeben}" oninput="updateRueckgeld(${index})"><br>
          <label class="edit-label" for="edit-rueckgeld">RÃ¼ckgeld (berechnet):</label>
          <input type="number" id="edit-rueckgeld" value="${entry.rueckgeld}" readonly><br>
          <label class="edit-label" for="edit-rueckgeldTats">RÃ¼ckgeld (tatsÃ¤chlich):</label>
          <input type="number" id="edit-rueckgeldTats" value="${entry.rueckgeldTats}" oninput="updateTrinkgeld(${index})"><br>
          <label class="edit-label" for="edit-trinkgeld">Trinkgeld (â‚¬):</label>
          <input type="number" id="edit-trinkgeld" value="${entry.trinkgeld}" readonly><br>
          <label class="edit-label" for="edit-ecZahlung">EC-Zahlung (â‚¬):</label>
          <input type="number" id="edit-ecZahlung" value="${entry.ecZahlung}"><br>
          <label class="edit-label" for="edit-ecTrinkgeld">Trinkgeld bei EC (â‚¬):</label>
          <input type="number" id="edit-ecTrinkgeld" value="${entry.ecTrinkgeld}"><br>
          <button class="btn-save" onclick="saveEdit(${index})">ğŸ’¾ Speichern</button>
        </div>`;
    }

    function updateRueckgeld(index) {
      const summe = parseFloat(document.getElementById("edit-summe").value) || 0;
      const gegeben = parseFloat(document.getElementById("edit-gegeben").value) || 0;
      const rueckgeld = Math.max(gegeben - summe, 0);
      document.getElementById("edit-rueckgeld").value = rueckgeld.toFixed(2);
      updateTrinkgeld(index);
    }

    function updateTrinkgeld(index) {
      const rueckgeld = parseFloat(document.getElementById("edit-rueckgeld").value) || 0;
      const rueckgeldTats = parseFloat(document.getElementById("edit-rueckgeldTats").value) || 0;
      const trinkgeld = Math.max(rueckgeld - rueckgeldTats, 0);
      document.getElementById("edit-trinkgeld").value = trinkgeld.toFixed(2);
    }

    function saveEdit(index) {
      const summe = parseFloat(document.getElementById("edit-summe").value) || 0;
      const gegeben = parseFloat(document.getElementById("edit-gegeben").value) || 0;
      const rueckgeld = parseFloat(document.getElementById("edit-rueckgeld").value) || 0;
      const rueckgeldTats = parseFloat(document.getElementById("edit-rueckgeldTats").value) || 0;
      const trinkgeld = parseFloat(document.getElementById("edit-trinkgeld").value) || 0;
      const ecZahlung = parseFloat(document.getElementById("edit-ecZahlung").value) || 0;
      const ecTrinkgeld = parseFloat(document.getElementById("edit-ecTrinkgeld").value) || 0;

      einnahmen[index] = {
        ...einnahmen[index],
        summe,
        gegeben,
        rueckgeld,
        rueckgeldTats,
        trinkgeld,
        ecZahlung,
        ecTrinkgeld
      };

      localStorage.setItem("einnahmen", JSON.stringify(einnahmen));
      displayEntries();
    }

    function resetData() {
      if (confirm("Sind Sie sicher, dass Sie alle Daten lÃ¶schen mÃ¶chten?")) {
        einnahmen = [];
        localStorage.removeItem("einnahmen");
        localStorage.removeItem("fahrername");
        displayEntries();
      }
    }

    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const fahrername = localStorage.getItem("fahrername") || "Unbekannt";

      doc.setFontSize(18);
      doc.text(`Taxi-Kasse von ${fahrername}`, 10, 10);

      const columns = [
        { header: "Datum/Uhrzeit", dataKey: "timestamp" },
        { header: "Bar (â‚¬)", dataKey: "summe" },
        { header: "EC (â‚¬)", dataKey: "ecZahlung" },
        { header: "RÃ¼ckgeld (berechnet)", dataKey: "rueckgeld" },
        { header: "RÃ¼ckgeld (tatsÃ¤chlich)", dataKey: "rueckgeldTats" },
        { header: "Trinkgeld Bar", dataKey: "trinkgeld" },
        { header: "Trinkgeld EC", dataKey: "ecTrinkgeld" }
      ];

      const rows = einnahmen.map(e => ({
        timestamp: e.timestamp,
        summe: e.summe.toFixed(2),
        ecZahlung: e.ecZahlung.toFixed(2),
        rueckgeld: e.rueckgeld.toFixed(2),
        rueckgeldTats: e.rueckgeldTats.toFixed(2),
        trinkgeld: e.trinkgeld.toFixed(2),
        ecTrinkgeld: e.ecTrinkgeld.toFixed(2),
      }));

      doc.autoTable({
        head: [columns.map(col => col.header)],
        body: rows.map(row => columns.map(col => row[col.dataKey])),
        startY: 20,
      });

      doc.save(`Taxi-Kasse_${fahrername}_${new Date().toISOString().slice(0,10)}.pdf`);
    }

    function shareWhatsApp() {
      const fahrername = localStorage.getItem("fahrername") || "Unbekannt";
      let message = `Taxi-Kasse von ${fahrername}:\n\n`;

      einnahmen.forEach(e => {
        message += `Datum: ${e.timestamp}\nBar: ${e.summe.toFixed(2)} â‚¬\nEC: ${e.ecZahlung.toFixed(2)} â‚¬\nTrinkgeld Bar: ${e.trinkgeld.toFixed(2)} â‚¬\nTrinkgeld EC: ${e.ecTrinkgeld.toFixed(2)} â‚¬\n\n`;
      });

      const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
      window.open(url, "_blank");
    }

    // Beim Laden: Fahrername aus localStorage setzen und EintrÃ¤ge anzeigen
    window.onload = () => {
      const gespeicherterName = localStorage.getItem("fahrername");
      if (gespeicherterName) {
        document.getElementById("fahrername").value = gespeicherterName;
      }
      displayEntries();
    };

    // Druckfunktion
   function printHTML() {
  const printWindow = window.open('', '_blank');
  const content = document.querySelector('.pdf-content').innerHTML;
  printWindow.document.write(`
    <html>
      <head>
        <title>Druckansicht Taxi-Kasse</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; }
          .entry { border: 1px solid #000; padding: 10px; margin-bottom: 10px; }
          .summary-box { border: 2px solid #000; padding: 15px; font-weight: bold; }
          h2 { text-align: center; }
        </style>
      </head>
      <body>
        <h2>Taxi-Kasse Druckansicht</h2>
        ${content}
      </body>
    </html>
  `);
  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
}
  </script>
</body>
</html>
